{"version":3,"sources":["full.mocha.js"],"names":[],"mappings":"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","file":"full.mocha.js","sourcesContent":["'use strict';\n\nimport fs from 'fs';\nimport co from 'co';\nimport naws from '..';\nimport supertest from 'supertest';\n\nfunction setup(port, session) {\n  let app = naws();\n  app\n    .set('base dir', __dirname)\n    .set('view dir', 'mock/view')\n    .set('asset dir', 'mock/asset')\n    .set('view engine', 'swig')\n    .init();\n\n  app.get('/', function *() { this.body = 'OK'; });\n  app.get('/render', app.render('full'));\n  app.get('/session', function *() { this.body = (this.session) ? 'OK' : 'NO'; });\n  app.post('/params/:check', function *() {\n    let p = this.state.naws.params;\n    this.body = (p.check === 'param' && p.qs === 'qs' && p.body === 'body') ? 'OK' : 'NO';\n  });\n  \n  app.get('/flash', function *(next) {\n    this.flash = 'OK';\n    this.redirect('/flash-2');\n  });\n\n  app.get('/flash-2', function *(next) {\n    this.body = this.flash;\n  });\n\n  app.get('/flash-3', function *(next) {\n    let flash = this.flash;\n    this.body = (typeof flash === 'object') && Object.keys(flash).length === 0;\n  });\n\n  app.get('/util/authcheck', \n    function *(next) {\n      this.session.user = {};\n      yield next;\n    },\n    app.util.authcheck('user', (ctx) => ctx.body = 'OK', (ctx) => ctx.body = 'NO'));\n  \n  // If session is enabled, use supertest's agent instead\n  if (session)\n    return supertest.agent(app.run(port));\n  else\n    return supertest(app.run(port));\n}\n\nfunction fread(path) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(path, 'utf8', (err, data) => {\n      if (err) return reject(err);\n      resolve(data);\n    });\n  });\n}\n\ndescribe('# Full test for NAWS', () => {\n\n  after(() => process.exit(0));\n  \n  // Simple test cases requiring only one single request to go through\n  describe('#one-req', () => {\n    let html = '';\n\n    before((done) => {\n      co(function *() {\n        // setup the HTML page\n        html = yield fread(__dirname + '/mock/html/full.html');\n      }).then(() => done()).catch((err) => done(err));\n    });\n\n    describe('simple', () => {\n      it('OK', (done) => {\n        setup(13711).get('/').expect('OK', done);\n      });\n    });\n\n    describe('params', () => {\n      it('OK', (done) => {\n        setup(13712).post('/params/param?qs=qs').send({body:'body'}).expect('OK', done);\n      })\n    });\n\n    describe('render', () => {\n      it('OK', (done) => {\n        setup(13713).get('/render').expect(html, done);\n      });\n    });\n\n    describe('asset', () => {\n      it('OK', (done) => {\n        setup(13714).get('/asset.txt').expect('hello', done);\n      });\n    });\n\n    describe('session', () => {\n      it('OK', (done) => {\n        setup(13715).get('/session').expect('OK', done);\n      });\n    });\n  });\n\n  \n  // More complex test cases requiring 2 requests launched in sequence\n  describe('#two-req', () => {\n    it('OK', (done) => {\n      let req = setup(13716, true);\n\n      req.get('/flash').redirects(2).expect('OK', () => {\n        req.get('/flash-3').expect('true', done);\n      });\n    });\n  });\n\n  describe('#util-check', () => {\n    it('OK', (done) => {\n      let req = setup(13717, true);\n\n      req.get('/util/authcheck').expect('OK', done);\n    });\n  });\n});"],"sourceRoot":"/source/"}